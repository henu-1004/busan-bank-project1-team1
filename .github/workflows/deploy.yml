name: GCP VM 배포 (API 및 AP 서버) - Build & Copy 방식

on:
  push:
    branches:
      - main

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # --- 1. 공통 설정 (인증) ---
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: GCP에 인증
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
        service_account: ${{ secrets.GCP_SA_EMAIL }}

    - name: gcloud CLI 설정
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: gcloud 베타 구성요소 설치
      run: gcloud components install beta --quiet

    # --- 2. bnk-api-server (flobank-api) 배포 ---
    
    # 2-1. [빌드] GitHub Actions 실행기에서 flobank-api 프로젝트를 빌드
    - name: bnk-api-server (flobank-api) 빌드
      run: |
        cd flobank-api
        chmod +x ./gradlew
        ./gradlew build -x test

    # 2-2. [복사] 빌드된 JAR 파일을 bnk-api-server VM으로 복사
    # Dockerfile이 app.jar를 찾으므로, 이름을 바꿔서 /opt/flobank-api/ 위치에 복사합니다.
    - name: bnk-api-server (flobank-api)에 JAR 파일 복사
      run: |
        JAR_FILE=$(find flobank-api/build/libs -name "*.jar" ! -name "*-plain.jar")
        
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: 실행 가능한 JAR 파일을 flobank-api/build/libs 에서 찾을 수 없습니다."
          exit 1
        fi
        
        gcloud beta compute scp "$JAR_FILE" \
          bnk-api-server:/tmp/app.jar \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a

    # 2-3. [실행] bnk-api-server VM에 접속해 Docker Compose 재시작
    - name: bnk-api-server (flobank-api) 재시작
      run: |
        gcloud beta compute ssh bnk-api-server \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a \
          --command="sudo rm -rf /opt/flobank-api/app.jar && sudo mv /tmp/app.jar /opt/flobank-api/app.jar && cd /opt/flobank-api && sudo docker-compose up -d --build --force-recreate"

    # --- 3. bnk-ap-server (flobank-ap) 배포 ---

    # 3-1. [빌드] GitHub Actions 실행기에서 flobank-ap 프로젝트를 빌드
    - name: bnk-ap-server (flobank-ap) 빌드
      run: |
        cd flobank-ap
        chmod +x ./gradlew
        ./gradlew build -x test

    # 3-2. [복사] 빌드된 JAR 파일을 bnk-ap-server VM으로 복사
    # Dockerfile이 app.jar를 찾으므로, 이름을 바꿔서 /opt/flobank-ap/ 위치에 복사합니다.
    - name: bnk-ap-server (flobank-ap)에 JAR 파일 복사
      run: |
        JAR_FILE=$(find flobank-ap/build/libs -name "*.jar" ! -name "*-plain.jar")
        
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: 실행 가능한 JAR 파일을 flobank-ap/build/libs 에서 찾을 수 없습니다."
          exit 1
        fi
        
        gcloud beta compute scp "$JAR_FILE" \
          bnk-ap-server:/tmp/app.jar \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a

    # 3-3. [실행] bnk-ap-server VM에 접속해 Docker Compose 재시작
    - name: bnk-ap-server (flobank-ap) 재시작
      run: |
        gcloud beta compute ssh bnk-ap-server \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a \
          --command="sudo rm -rf /opt/flobank-ap/app.jar && sudo mv /tmp/app.jar /opt/flobank-ap/app.jar && cd /opt/flobank-ap && sudo docker-compose up -d --build --force-recreate"