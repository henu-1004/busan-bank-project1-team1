name: GCP VM 배포 (API 및 AP 서버) - Build & Copy 방식

on:
  push:
    branches:
      - main

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # --- 1. 공통 설정 (인증) ---
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: GCP에 인증
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
        service_account: ${{ secrets.GCP_SA_EMAIL }}

    - name: gcloud CLI 설정
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: gcloud 베타 구성요소 설치
      run: gcloud components install beta --quiet

    # --- 2. bnk-api-server (flobank-api) 배포 ---
    
    # 2-1. [빌드] GitHub Actions 실행기에서 flobank-api 프로젝트를 빌드
    - name: bnk-api-server (flobank-api) 빌드
      run: |
        cd flobank-api
        chmod +x ./gradlew
        ./gradlew build -x test

    # 2-2. [복사] 빌드된 JAR 파일을 bnk-api-server VM으로 복사
    - name: bnk-api-server (flobank-api)에 JAR 파일 복사
      run: |
        JAR_FILE=$(find flobank-api/build/libs -name "*.jar" ! -name "*-plain.jar")
        
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: 실행 가능한 JAR 파일을 flobank-api/build/libs 에서 찾을 수 없습니다."
          exit 1
        fi
        
        gcloud beta compute scp "$JAR_FILE" \
          bnk-api-server:/tmp/app.jar \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a

    # 2-2.5. [복사] docker-compose.yml 파일을 bnk-api-server VM으로 복사
    - name: bnk-api-server compose 파일 복사
      run: |
        gcloud beta compute scp flobank-api/docker-compose.yml \
          bnk-api-server:/opt/flobank-api/docker-compose.yml \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a
        

    # 2-3. [실행] bnk-api-server VM에 접속해 Docker Compose 재시작
    - name: bnk-api-server (flobank-api) 재시작 및 정리
      run: |
        gcloud beta compute ssh bnk-api-server \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a \
          --command="
            sudo rm -rf /opt/flobank-api/app.jar && \
            sudo mv /tmp/app.jar /opt/flobank-api/app.jar && \
            cd /opt/flobank-api && \
            # 1. .env 파일 생성 (여기에 API 키 저장)
            echo 'OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}' | sudo tee .env > /dev/null && \
            # 2. Docker Compose 실행 (자동으로 .env를 읽음)
            sudo docker-compose down && \
            sudo docker-compose build --no-cache && \
            sudo docker-compose up -d && \
            sudo docker system prune -a -f
          "

    # 3-1. [빌드] GitHub Actions 실행기에서 flobank-ap 프로젝트를 빌드
    - name: bnk-ap-server (flobank-ap) 빌드
      run: |
        cd flobank-ap
        chmod +x ./gradlew
        ./gradlew build -x test

    # 3-2. [이미지 빌드 & Push] Elasticsearch 이미지를 만들어서 구글 저장소로 업로드
    - name: Elasticsearch 이미지 빌드 및 Push
      run: |
        # 1. GCP Docker 인증
        gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet
        
        # 2. 이미지 빌드 (nori 플러그인 포함)
        # 주의: docker build 명령은 Dockerfile이 있는 폴더(flobank-ap/elastic)를 지정해야 합니다.
        docker build -t asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/flobank-repo/flobank-elasticsearch:latest ./flobank-ap/elastic
        
        # 3. 이미지 업로드 (Push)
        docker push asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/flobank-repo/flobank-elasticsearch:latest

    # 3-3. [파일 복사] JAR 파일, docker-compose.yml, Dockerfile 복사
    - name: bnk-ap-server 파일 복사
      run: |
        JAR_FILE=$(find flobank-ap/build/libs -name "*.jar" ! -name "*-plain.jar")
        
        # 1. JAR 파일 전송
        gcloud beta compute scp "$JAR_FILE" \
          bnk-ap-server:/tmp/app.jar \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a
          
        # 2. docker-compose.yml 전송
        gcloud beta compute scp flobank-ap/docker-compose.yml \
          bnk-ap-server:/tmp/docker-compose.yml \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a

        # 3. App용 Dockerfile 전송 (혹시 없을 경우를 대비해 안전하게 복사)
        gcloud beta compute scp flobank-ap/Dockerfile \
          bnk-ap-server:/tmp/Dockerfile \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a

    # 3-4. [실행] 서버는 이미지를 다운로드(Pull)만 해서 실행
    - name: bnk-ap-server (flobank-ap) 재시작 및 정리
      run: |
        gcloud beta compute ssh bnk-ap-server \
          --project=${{ secrets.GCP_PROJECT_ID }} \
          --zone=asia-northeast3-a \
          --command="
            # 1. GCP Docker 인증
            gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet

            # 2. 파일 이동
            sudo rm -rf /opt/flobank-ap/app.jar
            sudo mv /tmp/app.jar /opt/flobank-ap/app.jar
            sudo mv /tmp/docker-compose.yml /opt/flobank-ap/docker-compose.yml
            sudo mv /tmp/Dockerfile /opt/flobank-ap/Dockerfile
            
            # 3. 컨테이너 재시작
            cd /opt/flobank-ap
            sudo docker-compose down
            
            # [핵심 1] Elasticsearch 최신 이미지 다운로드
            sudo docker-compose pull
            
            # [핵심 2] 실행
            # --build 옵션이 있어야 'flobank-ap'는 새 JAR로 다시 빌드되고,
            # 'elasticsearch'는 위에서 받은 이미지를 그대로 사용합니다.
            sudo docker-compose up -d --build
            
            # 불필요한 이미지 정리
            sudo docker image prune -f
          "