<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>간편인증</title>
    <style>
        /* 기본 스타일 초기화 및 고용24 스타일 모방 */
        body { margin: 0; padding: 0; font-family: 'Malgun Gothic', 'Noto Sans KR', sans-serif; background-color: #f5f6f8; color: #333; }
        .container { width: 100%; height: 100vh; display: flex; flex-direction: column; background: #fff; max-width: 450px; margin: 0 auto; position: relative; }

        /* 헤더 */
        .header { height: 50px; background: #0f1f3e; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; position: relative; }
        .close-btn { position: absolute; right: 15px; cursor: pointer; font-size: 20px; }

        /* 컨텐츠 영역 */
        .content { flex: 1; padding: 20px; overflow-y: auto; display: none; /* 기본 숨김 */ flex-direction: column; }
        .content.active { display: flex; }

        /* 공통 UI 요소 */
        h2 { font-size: 20px; margin-bottom: 20px; color: #111; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 14px; color: #666; margin-bottom: 5px; }
        .form-input { width: 100%; height: 45px; padding: 0 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .btn-full { width: 100%; height: 50px; background: #007bff; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: auto; border-radius: 0; }
        .btn-full:disabled { background: #ccc; }

        /* Step 1: 인증서 선택 */
        .provider-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .provider-item { border: 1px solid #eee; border-radius: 8px; padding: 10px 5px; text-align: center; cursor: pointer; }
        .provider-item:hover, .provider-item.selected { border-color: #007bff; background: #f0f7ff; }
        .provider-icon { width: 40px; height: 40px; border-radius: 50%; display: block; margin: 0 auto 5px; background: #eee; }
        .provider-name { font-size: 12px; }

        /* Step 3: 약관 */
        .terms-box { border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .term-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .term-btn { color: #007bff; text-decoration: none; font-size: 12px; cursor: pointer; }

        /* Step 5: 대기 화면 */
        .waiting-box { text-align: center; margin-top: 50px; }
        .phone-icon { font-size: 60px; color: #ffd700; margin-bottom: 20px; }
        .waiting-text { font-size: 16px; line-height: 1.5; }
        .guide-box { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 30px; text-align: left; font-size: 13px; color: #666; }

        /* 카카오 아이콘 스타일 (노란색) */
        .kakao-bg { background-color: #ffe812; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
</head>
<body>

<div class="container">
    <div class="header">
        간편인증
        <span class="close-btn" onclick="window.close()">✕</span>
    </div>

    <div id="step1" class="content active">
        <h2>민간 인증서</h2>
        <div class="form-group">
            <div class="provider-list">
                <div class="provider-item" onclick="selectProvider(this, 'KAKAO')">
                    <div class="provider-icon kakao-bg"><i class="fa-solid fa-comment"></i></div>
                    <div class="provider-name">카카오톡</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'PASS')">
                    <div class="provider-icon" style="background:#e60012; color:white; display:flex; align-items:center; justify-content:center;">P</div>
                    <div class="provider-name">통신사PASS</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'KB')">
                    <div class="provider-icon" style="background:#ffcc00; display:flex; align-items:center; justify-content:center;">KB</div>
                    <div class="provider-name">KB인증서</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'NAVER')">
                    <div class="provider-icon" style="background:#03c75a; color:white; display:flex; align-items:center; justify-content:center;">N</div>
                    <div class="provider-name">네이버</div>
                </div>

                <div class="provider-item" onclick="selectProvider(this, 'TOSS')">
                    <div class="provider-icon" style="background:#0064FF; color:white; display:flex; align-items:center; justify-content:center;">T</div>
                    <div class="provider-name">토스</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'SAMSUNG')">
                    <div class="provider-icon" style="background:#1428A0; color:white; display:flex; align-items:center; justify-content:center;">S</div>
                    <div class="provider-name">삼성패스</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'SHINHAN')">
                    <div class="provider-icon" style="background:#0050FF; color:white; display:flex; align-items:center; justify-content:center;">S</div>
                    <div class="provider-name">신한</div>
                </div>
                <div class="provider-item" onclick="selectProvider(this, 'PAYCO')">
                    <div class="provider-icon" style="background:#FA2828; color:white; display:flex; align-items:center; justify-content:center;">P</div>
                    <div class="provider-name">페이코</div>
                </div>
            </div>
        </div>
        <button class="btn-full" id="btnStep1" disabled onclick="goStep2()">다음</button>
    </div>

    <div id="step2" class="content">
        <h2>본인 확인</h2>

        <div class="form-group">
            <label class="form-label">이름</label>
            <input type="text" class="form-input" id="userName" placeholder="이름 입력">
        </div>
        <div class="form-group">
            <label class="form-label">생년월일 (8자리)</label>
            <input type="text" class="form-input" id="userBirth" placeholder="19990101" maxlength="8">
        </div>
        <div class="form-group">
            <label class="form-label">휴대폰 번호</label>
            <div style="display:flex; gap:5px;">
                <input type="text" class="form-input" value="010" readonly style="width:30%;">
                <input type="text" class="form-input" id="userPhone" placeholder="12341234" maxlength="8">
            </div>
        </div>

        <button class="btn-full" onclick="goStep3()">다음</button>
    </div>

    <div id="step3" class="content">
        <h2>서비스 이용약관 동의</h2>
        <div class="terms-box">
            <div class="term-row">
                <label><input type="checkbox" class="term-chk"> 개인정보 이용 동의 (필수)</label>
                <span class="term-btn">보기</span>
            </div>
            <div class="term-row">
                <label><input type="checkbox" class="term-chk"> 서비스이용약관 동의 (필수)</label>
                <span class="term-btn">보기</span>
            </div>
            <div class="term-row">
                <label><input type="checkbox" class="term-chk"> 제3자 정보제공 동의 (필수)</label>
                <span class="term-btn">보기</span>
            </div>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="font-weight:bold;">
                <input type="checkbox" id="checkAll" onchange="toggleAll(this)"> 모두 동의하고 인증요청
            </label>
        </div>
        <button class="btn-full" onclick="goStep4()">인증요청</button>
    </div>

    <div id="step4" class="content" style="background:#333; color:white; justify-content:center; align-items:center;">
        <div style="text-align:center;">
            <div style="font-size:50px; margin-bottom:20px; color: #ffd700;"> <i class="fa-solid fa-spinner fa-spin"></i>
            </div>

            <h3>카카오 인증서로 인증합니다</h3>
            <p id="reqInfo" style="font-size:14px; color:#ccc; margin-top:10px;"></p>
        </div>
    </div>

    <div id="step5" class="content">
        <div class="waiting-box">
            <div class="phone-icon">
                <i class="fa-solid fa-mobile-screen-button"></i>
                <div style="font-size:14px; background:yellow; color:black; border-radius:50%; width:24px; height:24px; line-height:24px; display:inline-block; position:relative; top:-40px; left:-10px;">talk</div>
            </div>
            <h3>인증을 진행해 주세요.</h3>
            <p class="waiting-text">
                입력하신 휴대폰으로 인증 요청 메시지를 보냈습니다.<br>
                <strong>카카오톡 앱</strong>에서 인증을 진행해주세요.
            </p>
        </div>

        <div class="guide-box">
            <p>1. 카카오톡 실행 > 2. 인증 요청 메시지 확인 > 3. 비밀번호 입력(인증완료)</p>
        </div>

        <button class="btn-full" onclick="checkCompletion()">인증 완료</button>
    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const requestTitle = /*[[${title}]]*/ '전자서명';
    /*]]>*/

    // Step 1: 통신사 선택
    function selectProvider(element, type) {
        document.querySelectorAll('.provider-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('btnStep1').disabled = false;

        // 카카오가 아니면 알림 (예제용)
        if(type !== 'KAKAO') {
            alert('현재 데모에서는 카카오톡만 지원합니다.');
            selectProvider(document.querySelector('.provider-item:first-child'), 'KAKAO');
        }
    }

    // 화면 전환 함수
    function showScreen(stepId) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.getElementById(stepId).classList.add('active');
    }

    function goStep2() {
        showScreen('step2');
    }

    function goStep3() {
        const name = document.getElementById('userName').value;
        const birth = document.getElementById('userBirth').value;
        const phone = document.getElementById('userPhone').value;

        if(!name || birth.length < 8 || phone.length < 7) {
            alert('정보를 올바르게 입력해주세요.');
            return;
        }
        showScreen('step3');
    }

    // 약관 전체 동의
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.term-chk');
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    function goStep4() {
        // 약관 검사
        const checkboxes = document.querySelectorAll('.term-chk');
        for(let cb of checkboxes) {
            if(!cb.checked) {
                alert('필수 약관에 모두 동의해주세요.');
                return;
            }
        }

        // 로딩 화면 표시 (Step 4)
        document.getElementById('reqInfo').innerText =
            document.getElementById('userName').value + "님에게 인증요청을 보냅니다.";
        showScreen('step4');

        // 2초 뒤 인증 대기 화면(Step 5)으로 자동 전환 (통신 시뮬레이션)
        setTimeout(() => {
            showScreen('step5');
        }, 2000);
    }

    // 최종 완료 버튼 클릭 (사용자가 폰에서 인증 후 누르는 버튼)
    function checkCompletion() {
        // 서버에 완료 상태 전송
        fetch('/flobank/api/cert/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: 'SUCCESS' })
        })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    showSuccessScreen();

                    document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh;'><h3>처리 중입니다...<br>잠시만 기다려주세요.</h3></div>";
                }
            });
    }

    // [추가] 성공 화면 그리기 함수
    function showSuccessScreen() {
        // body 내용을 전부 지우고 성공 아이콘과 메시지로 채움
        document.body.innerHTML = `
        <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:#fff; text-align:center;">
            <div style="font-size:60px; color:#007bff; margin-bottom:20px;">
                <i class="fa-regular fa-circle-check"></i>
            </div>
            <h2 style="margin:0 0 10px 0; color:#333;">인증 완료</h2>
            <p style="color:#666; font-size:14px;">본인 인증이 성공적으로 완료되었습니다.<br>잠시 후 창이 닫힙니다.</p>
        </div>
    `;
    }
</script>

</body>
</html>