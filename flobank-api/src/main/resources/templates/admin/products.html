<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/admin_template :: admin_template('ì™¸í™”ì˜ˆê¸ˆ ê´€ë¦¬','ì™¸í™”ì˜ˆê¸ˆ ê´€ë¦¬',~{::content},~{::script})}">

<th:block th:fragment="content">

    <div class="product-container">

        <!-- =======================
             PDF ì—…ë¡œë“œ / AI ë¶„ì„
        ======================== -->
        <section class="product-card">
            <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ ë“±ë¡</h2>

            <form id="foreignDepositForm"
                  th:action="@{/admin/products/register}"
                  method="post"
                  enctype="multipart/form-data">

                <div class="form-section">
                    <h3>ìƒí’ˆì„¤ëª…ì„œ AI ë¶„ì„ ì¤€ë¹„</h3>

                    <div class="form-group">
                        <label for="dpstInfoPdfUpload">PDF íŒŒì¼ ì„ íƒ</label>
                        <div class="pdf-upload-controls">
                            <input type="file" id="dpstInfoPdfUpload" accept=".pdf" />
                            <button type="button" id="btnPdfUpload" class="btn-secondary">ì—…ë¡œë“œ</button>
                        </div>
                    </div>

                    <!-- ğŸ”¥ Progress Box ì¶”ê°€ -->
                    <div id="pdf-progress-box"
                         style="display:none; margin:10px 0; padding:10px; background:#f5f7fa; border-radius:6px;">
                        <div style="font-weight:bold; margin-bottom:5px;">
                            AI ë¶„ì„ ì§„í–‰ë¥ :
                            <span id="pdf-progress-text">0%</span>
                        </div>
                        <div style="width:100%; background:#e1e4e8; height:12px; border-radius:6px;">
                            <div id="pdf-progress-bar"
                                 style="width:0%; height:100%; background:#4A90E2; border-radius:6px; transition:width 0.3s;"></div>
                        </div>
                    </div>
                    <!-- ğŸ”¥ Progress Box ë -->

                    <div class="pdf-list">
                        <div class="pdf-list-header" id="pdfListHeader">
                            <div class="pdf-list-title">
                                <span class="pdf-list-arrow" id="pdfListArrow">â–²</span>
                                <span>ì—…ë¡œë“œëœ PDF ëª©ë¡</span>
                            </div>
                            <span class="status-legend">ìƒíƒœ: wait / done / used</span>
                        </div>
                        <div class="pdf-list-body" id="pdfListBody">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="pdfSelector">AI ë¶„ì„ ì™„ë£Œ PDF ì„ íƒ (doneë§Œ ì„ íƒ ê°€ëŠ¥)</label>
                        <select id="pdfSelector" name="donePdf" class="pdf-select">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <input type="hidden" id="selectedPdfPath" name="selectedPdfPath" />
                    <input type="hidden" id="selectedPdfName" name="selectedPdfName" />
                    <input type="hidden" id="selectedPdfId" name="selectedPdfId" />
                    <div id="selectedPdfNotice" class="selected-pdf-notice" style="display:none;"></div>

                    <div class="ai-comment-box">
                        <div id="aiRiskBlockMessage" class="risk-block-message" style="display:none;">
                            ìœ„í—˜ ìƒí’ˆì„¤ëª…ì„œ â†’ ìƒí’ˆ ë“±ë¡ ë¶ˆê°€
                        </div>
                        <div class="ai-comment-header">
                            <h4>AI ë¶„ì„ ì½”ë©˜íŠ¸</h4>
                            <span class="ai-comment-status" id="aiRiskBadge">AI ë¶„ì„ ì½”ë©˜íŠ¸ í‘œì‹œ ì˜ˆì •</span>
                        </div>
                        <div id="aiCommentContent" class="ai-comment-content">
                            <p class="ai-comment-placeholder">AI ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìƒì„±ëœ ì½”ë©˜íŠ¸ê°€ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                <h3>ê¸°ë³¸ì •ë³´</h3>
                <div class="form-group">
                    <label for="dpstName">ìƒí’ˆëª…</label>
                    <input type="text" id="dpstName" name="dpstName" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                </div>
                <div class="form-group">
                    <label for="dpstInfo">ìƒí’ˆ í•œ ì¤„ ì„¤ëª…</label>
                    <input type="text" id="dpstInfo" name="dpstInfo" placeholder="ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
                </div>
                <div class="form-group">
                    <label>ì˜ˆê¸ˆ ìœ í˜•</label>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstType" value="1" checked /> ê±°ì¹˜ì‹ ì˜ˆê¸ˆ</label>
                        <label><input type="radio" name="dpstType" value="2" /> ììœ  ì ë¦½ì‹</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>í†µí™” ë° ê¸ˆì•¡ ì„¤ì •</h3>
                <div class="form-group">
                    <label>ê°€ëŠ¥í•œ í†µí™”</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="dpstCurrency" value="USD" /> USD(ë¯¸êµ­ ë‹¬ëŸ¬)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="JPY" /> JPY(ì¼ë³¸ ì—”í™”)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="EUR" /> EUR(ìœ ë¡œí™”)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="GBP" /> GBP(ì˜êµ­ íŒŒìš´ë“œ)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="CNH" /> CNH(ì¤‘êµ­ ìœ„ì•ˆ)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="AUD" /> AUD(í˜¸ì£¼ ë‹¬ëŸ¬)</label>
                    </div>
                </div>
                <div class="conditional deposit-type" data-type="1">
                    <div id="currencyAmountContainer"></div>
                    <div class="form-group">
                        <label>ì¶”ê°€ë‚©ì… ê°€ëŠ¥ ì—¬ë¶€</label>
                        <div class="radio-group">
                            <label><input type="radio" name="dpstAddPayYn" value="Y" /> ê°€ëŠ¥</label>
                            <label><input type="radio" name="dpstAddPayYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                        </div>
                    </div>
                    <div class="conditional extra-deposit">
                        <div class="form-group">
                            <label>ì‹ ê·œ í¬í•¨ ìµœëŒ€ ë‚©ì… íšŸìˆ˜</label>
                            <input type="number" name="dpstAddPayMax" placeholder="ì˜ˆ: 3" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>í™˜ìœ¨ ì ìš© ê¸°ì¤€</h3>
                <div class="radio-group">
                    <label><input type="radio" name="dpstRateType" value="1" checked /> ê°€ì… ì‹œì </label>
                    <label><input type="radio" name="dpstRateType" value="2" /> ë§Œê¸° ì‹œì </label>
                    <label><input type="radio" name="dpstRateType" value="3" /> ë‚©ì… ì‹œ í™˜ìœ¨</label>
                </div>
            </div>

            <div class="form-section">
                <h3>ìƒí’ˆ ì •ë³´</h3>
                <div class="form-group">
                    <label for="dpstDescript">ìƒí’ˆ ê°œìš”</label>
                    <textarea id="dpstDescript" name="dpstDescript" rows="3" placeholder="ìƒí’ˆ íŠ¹ì§• ë° ì•ˆë‚´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <div class="form-group">
                    <label>ìƒí’ˆ ê°€ì…ê¸°ê°„ ìœ í˜•</label>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstPeriodType" value="1" checked /> ììœ í˜•</label>
                        <label><input type="radio" name="dpstPeriodType" value="2" /> ê³ ì •í˜•</label>
                    </div>
                </div>
                <div class="conditional join-type" data-type="1">
                    <div class="form-inline">
                        <label>ìµœì†Œ ê°€ì…ì›”ìˆ˜</label>
                        <input type="number" name="minMonths" placeholder="ì˜ˆ: 1" /> ê°œì›”
                    </div>
                    <div class="form-inline">
                        <label>ìµœëŒ€ ê°€ì…ì›”ìˆ˜</label>
                        <input type="number" name="maxMonths" placeholder="ì˜ˆ: 36" /> ê°œì›”
                    </div>
                </div>
                <div class="conditional join-type" data-type="2">
                    <div class="form-group">
                        <label>ê°€ì… ê°€ëŠ¥í•œ ê°œì›”ìˆ˜</label>
                        <input type="text" name="fixedMonths" placeholder="ì˜ˆ: 3,6,12" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ê°€ì… ëŒ€ìƒ</h3>
                <div class="radio-group">
                    <label><input type="radio" name="ageLimit" value="none" checked /> ì œí•œ ì—†ìŒ</label>
                    <label><input type="radio" name="ageLimit" value="yes" /> ì œí•œ ìˆìŒ</label>
                </div>
                <div class="conditional age-limit">
                    <div class="form-inline">
                        <label>ìµœì†Œ ë‚˜ì´</label>
                        <input type="number" name="dpstMinAge" placeholder="ì˜ˆ: 19" /> ì„¸
                    </div>
                    <div class="form-inline">
                        <label>ìµœëŒ€ ë‚˜ì´</label>
                        <input type="number" name="dpstMaxAge" placeholder="ì˜ˆ: 65" /> ì„¸
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ë¶„í•  ì¸ì¶œ ì„¤ì •</h3>
                <div class="radio-group">
                    <label><input type="radio" name="dpstPartWdrwYn" value="Y" /> ê°€ëŠ¥</label>
                    <label><input type="radio" name="dpstPartWdrwYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                </div>
                <div class="conditional partial-withdrawal">
                    <div class="form-group">
                        <label>ê°€ëŠ¥ ì‹œì  (ê°€ì… í›„)</label>
                        <input type="number" name="withdrawAfterMonths" placeholder="ì˜ˆ: 6" /> ê°œì›” ì´í›„
                    </div>
                    <div class="form-group">
                        <label>ìµœëŒ€ ì¸ì¶œ ê°€ëŠ¥ íšŸìˆ˜</label>
                        <input type="number" name="withdrawCount" placeholder="ì˜ˆ: 3íšŒ" />
                    </div>
                    <div id="withdrawCurrencyContainer"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>ìë™ì—°ì¥ ì„¤ì •</h3>
                <div class="radio-group">
                    <label><input type="radio" name="dpstAutoRenewYn" value="Y" /> ê°€ëŠ¥</label>
                    <label><input type="radio" name="dpstAutoRenewYn" value="N" checked /> ë¶ˆê°€ëŠ¥</label>
                </div>
                <div class="conditional auto-renew">
                    <div class="form-group">
                        <label>ì—°ì¥ ê¸°ê°„ ì„ íƒ</label>
                        <select name="renewPeriod">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="1">1ê°œì›”</option>
                            <option value="3">3ê°œì›”</option>
                            <option value="6">6ê°œì›”</option>
                            <option value="12">12ê°œì›”</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>ìƒí’ˆì„¤ëª…ì„œ ì²¨ë¶€</h3>
                <div class="form-group">
                    <input type="file" name="pdfFile" accept=".pdf,.doc,.docx" />
                </div>
            </div>

            <div class="form-section">
                <h3>ìƒí’ˆ ê°œì‹œì¼ì</h3>
                <div class="form-group">
                    <label for="dpstRegDt">ê°œì‹œì¼ì ì„ íƒ</label>
                    <input type="date" id="dpstRegDt" name="dpstRegDt" required />
                </div>
            </div>

            <div class="form-submit">
                <button type="submit" class="btn-submit">ë“±ë¡í•˜ê¸°</button>
            </div>

        </form> </section>



    <section class="product-card">

        <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ ê´€ë¦¬</h2>

        <div class="product-tabs">
            <button class="tab-btn active" data-status="approve">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</button>
            <button class="tab-btn" data-status="pending">ìƒí’ˆ ë“±ë¡ ëŒ€ê¸° ì¤‘</button>
        </div>

        <div class="product-table-wrap" data-status-group="approve">
            <table class="product-table">
                <thead>
                <tr>
                    <th>ìƒí’ˆëª…</th>
                    <th>ìƒíƒœ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${approveList}" data-status="approve" th:data-id="${p.dpstId}">
                    <td th:text="${p.dpstName}"></td>
                    <td><span class="status-badge status-approve">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span></td>
                    <td><button class="btn-approve">ìŠ¹ì¸</button></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="product-table-wrap" data-status-group="pending" style="display:none;">
            <table class="product-table">
                <thead>
                <tr>
                    <th>ìƒí’ˆëª…</th>
                    <th>ìƒíƒœ</th>
                    <th>ìƒí’ˆ ê°œì‹œì¼</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pendingList}" th:data-id="${p.dpstId}">
                    <td th:text="${p.dpstName}"></td>
                    <td><span class="status-badge status-pending">ìƒí’ˆ ë“±ë¡ ëŒ€ê¸° ì¤‘</span></td>
                    <td th:text="${p.dpstRegDt}"></td>
                </tr>
                </tbody>
            </table>
        </div>

    </section>


    <section class="product-card">
        <h2 class="product-title">ì™¸í™”ì˜ˆê¸ˆ ìƒí’ˆ í˜„í™©</h2>

        <div class="product-table-wrap">
            <table class="product-table">
                <thead>
                <tr>
                    <th>ìƒí’ˆëª…</th>
                    <th>ìƒí’ˆíŒë§¤ê°œì‹œì¼ì‹œ</th>
                    <th>ê°€ì…ììˆ˜</th>
                    <th>ìƒíƒœ</th>
                </tr>
                </thead>
                <tbody>

                <tr th:each="p : ${saleList}">
                    <td>
                        <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                           class="product-link"
                           th:text="${p.dpstName}"></a>
                    </td>
                    <td th:text="${p.dpstRegDt}"></td>
                    <td>0</td>
                    <td><span class="status-badge status-sale">íŒë§¤ì¤‘</span></td>
                </tr>

                <tr th:each="p : ${stopList}">
                    <td>
                        <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                           class="product-link"
                           th:text="${p.dpstName}"></a>
                    </td>
                    <td th:text="${p.dpstRegDt}"></td>
                    <td>0</td>
                    <td><span class="status-badge status-stop">íŒë§¤ì¤‘ë‹¨</span></td>
                </tr>

                </tbody>
            </table>
        </div>
    </section>

</div>
</th:block>

<th:block th:fragment="script">

    <script>
        /* ============================
           SSE ì „ì—­ ë³€ìˆ˜
        ============================= */
        let currentEventSource = null;

        const AI_PLACEHOLDER = "AI ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìƒì„±ëœ ì½”ë©˜íŠ¸ê°€ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.";

        /* ============================
           ğŸ“¡ SSE ì—°ê²° í•¨ìˆ˜
        ============================= */
        function connectProgressSSE(pdfId) {
            if (!pdfId) return;

            if (currentEventSource) {
                currentEventSource.close();
            }

            const url = `/pdf-ai/progress/${pdfId}`;
            console.log("ğŸ”Œ SSE ì—°ê²°:", url);

            const box = document.getElementById("pdf-progress-box");
            const bar = document.getElementById("pdf-progress-bar");
            const text = document.getElementById("pdf-progress-text");

            box.style.display = "block";

            currentEventSource = new EventSource(url);

            currentEventSource.onmessage = function (event) {

                const progress = Number(event.data);
                console.log("ğŸ“¡ SSE Progress:", progress);

                bar.style.width = `${progress}%`;
                text.textContent = `${progress}%`;

                // 100% â†’ ìë™ ì¢…ë£Œ
                if (progress >= 100) {
                    setTimeout(() => {
                        box.style.display = "none";
                        bar.style.width = "0%";
                        text.textContent = "0%";
                        currentEventSource.close();
                    }, 3000);
                }

                // ì—ëŸ¬ (-1)
                if (progress === -1) {
                    text.textContent = "ì—ëŸ¬ ë°œìƒ";
                    bar.style.background = "red";
                }
            };

            currentEventSource.onerror = function () {
                console.log("âŒ SSE ì˜¤ë¥˜ â†’ ì—°ê²° ì¢…ë£Œ");
                currentEventSource.close();
            };
        }

        /* ============================
           ğŸ“‘ í—¬í¼ í•¨ìˆ˜
        ============================= */
        function formatDateTime(value) {
            if (!value) return "";
            const date = new Date(value);
            if (isNaN(date.getTime())) return value;
            return date.toLocaleString("ko-KR", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }

        function resetAiCommentBox() {
            const badge = document.getElementById("aiRiskBadge");
            const content = document.getElementById("aiCommentContent");

            if (badge) {
                badge.textContent = "AI ë¶„ì„ ì½”ë©˜íŠ¸ í‘œì‹œ ì˜ˆì •";
                badge.className = "ai-comment-status";
            }

            if (content) {
                content.innerHTML = `<p class="ai-comment-placeholder">${AI_PLACEHOLDER}</p>`;
            }

            updateRiskGuard(null);
            updateSelectedPdfInputs();
        }

        function parseAiComments(aiComment, aiOverallRisk) {
            let overallRisk = aiOverallRisk || null;
            let comments = [];

            if (aiComment) {
                try {
                    const parsed = JSON.parse(aiComment);
                    overallRisk = parsed.overall_risk || parsed.overallRisk || overallRisk;
                    if (Array.isArray(parsed.comments)) {
                        comments = parsed.comments;
                    }
                } catch (e) {
                    comments = [aiComment];
                }
            }

            return { overallRisk, comments };
        }

        function updateSelectedPdfInputs(pdf) {
            const pathInput = document.getElementById("selectedPdfPath");
            const nameInput = document.getElementById("selectedPdfName");
            const idInput = document.getElementById("selectedPdfId");
            const noticeEl = document.getElementById("selectedPdfNotice");

            if (!pdf) {
                if (pathInput) pathInput.value = "";
                if (nameInput) nameInput.value = "";
                if (idInput) idInput.value = "";
                if (noticeEl) {
                    noticeEl.style.display = "none";
                    noticeEl.textContent = "";
                }
                return;
            }

            if (pathInput) pathInput.value = pdf.filePath || "";
            if (nameInput) nameInput.value = pdf.storedFileName || "";
            if (idInput) idInput.value = pdf.pdfId || "";

            if (noticeEl) {
                const filename = pdf.orgFileName || pdf.storedFileName || "ì„ íƒí•œ PDF";
                noticeEl.style.display = "block";
                noticeEl.textContent = `${filename}ê°€ ìë™ìœ¼ë¡œ ë“±ë¡ íŒŒì¼ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
        }

        function updateRiskGuard(risk) {
            const submitBtn = document.querySelector(".btn-submit");
            const blockMessage = document.getElementById("aiRiskBlockMessage");

            const normalized = (risk || "").toString().toLowerCase();
            const isDanger = normalized.includes("danger") || normalized.includes("ìœ„í—˜");

            if (submitBtn) {
                submitBtn.disabled = isDanger;
            }

            if (blockMessage) {
                blockMessage.style.display = isDanger ? "block" : "none";
            }
        }

        function buildCommentItem(comment) {
            const item = document.createElement("div");
            item.classList.add("ai-comment-item");

            if (typeof comment === "string") {
                const text = document.createElement("p");
                text.classList.add("ai-comment-text");
                text.textContent = comment;
                item.appendChild(text);
                return item;
            }

            const phrase = comment.risky_phrase || comment.riskyPhrase;
            const reason = comment.violation_reason || comment.violationReason;
            const suggestion = comment.improvement_suggestion || comment.improvementSuggestion;

            const rows = [
                { label: "ìœ„í—˜ ë¬¸êµ¬", value: phrase, className: "ai-comment-phrase" },
                { label: "ìœ„ë°˜/ë¶„ì„", value: reason, className: "ai-comment-reason" },
                { label: "ê°œì„  ë°©í–¥", value: suggestion, className: "ai-comment-suggestion" }
            ];

            rows.forEach(row => {
                if (!row.value) return;
                const rowEl = document.createElement("div");
                rowEl.className = "ai-comment-row";

                const labelEl = document.createElement("div");
                labelEl.className = "ai-comment-label";
                labelEl.textContent = row.label;

                const valueEl = document.createElement("div");
                valueEl.className = row.className;
                valueEl.textContent = row.value;

                rowEl.appendChild(labelEl);
                rowEl.appendChild(valueEl);
                item.appendChild(rowEl);
            });

            if (!phrase && !reason && !suggestion) {
                const fallback = document.createElement("p");
                fallback.classList.add("ai-comment-text");
                fallback.textContent = "ì¶”ê°€ ì½”ë©˜íŠ¸ ì—†ìŒ";
                item.appendChild(fallback);
            }

            return item;
        }

        function renderAiComments(pdf) {
            const badge = document.getElementById("aiRiskBadge");
            const content = document.getElementById("aiCommentContent");

            if (!badge || !content) return;

            const { overallRisk, comments } = parseAiComments(pdf.aiComment, pdf.aiOverallRisk);

            const riskText = overallRisk || "ë¶„ì„ ëŒ€ê¸°";
            const riskClass = riskText.toLowerCase().replace(/\s+/g, "");
            badge.textContent = `ìœ„í—˜ë„: ${riskText}`;
            badge.className = `ai-comment-status ai-risk-${riskClass}`;
            updateRiskGuard(overallRisk);

            content.innerHTML = "";

            if (!comments || comments.length === 0) {
                content.innerHTML = `<p class="ai-comment-placeholder">${AI_PLACEHOLDER}</p>`;
                return;
            }

            comments.forEach(comment => content.appendChild(buildCommentItem(comment)));
        }

        function setRadioValue(name, value) {
            if (!value) return;
            const target = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (target) {
                target.checked = true;
                target.dispatchEvent(new Event("change", { bubbles: true }));
            }
        }

        function applyPdfDataToForm(pdf) {
            if (!pdf) return;

            updateSelectedPdfInputs(pdf);

            const nameInput = document.getElementById("dpstName");
            const infoInput = document.getElementById("dpstInfo");
            const descriptInput = document.getElementById("dpstDescript");

            if (pdf.productName && nameInput) nameInput.value = pdf.productName;
            if (pdf.productShortDesc && infoInput) infoInput.value = pdf.productShortDesc;
            if (pdf.productFeatures && descriptInput) descriptInput.value = pdf.productFeatures;

            /* ì˜ˆê¸ˆ ìœ í˜• */
            const depositValue = (pdf.depositType || "").includes("ê±°ì¹˜") ? "1" : (pdf.depositType ? "2" : null);
            setRadioValue("dpstType", depositValue);

            /* í†µí™” */
            const currencyText = pdf.currencies || "";
            const currencyCodes = currencyText.split(/[,\s]+/).map(c => c.trim()).filter(Boolean);
            const currencyBoxes = document.querySelectorAll('input[name="dpstCurrency"]');
            currencyBoxes.forEach(box => {
                box.checked = currencyCodes.includes(box.value);
                box.dispatchEvent(new Event("change", { bubbles: true }));
            });

            /* í™˜ìœ¨ ì •ì±… */
            const policy = (pdf.exchangeRatePolicy || "").replace(/\s/g, "").toLowerCase();
            let rateValue = null;

            if (policy.includes("ë‚©ì…")) {
                rateValue = "3";
            } else if (policy.includes("ë§Œê¸°")) {
                rateValue = "2";
            } else if (policy.includes("ê°€ì…")) {
                rateValue = "1";
            }

            setRadioValue("dpstRateType", rateValue);

            /* ê°€ì… ê¸°ê°„ */
            const termText = pdf.termType || "";
            let joinType = null;

            if (pdf.minMonth != null || pdf.maxMonth != null || termText.includes("ììœ ")) {
                joinType = "1";
            } else if (termText) {
                joinType = "2";
            }

            setRadioValue("dpstPeriodType", joinType);

            const minMonths = document.querySelector('input[name="minMonths"]');
            const maxMonths = document.querySelector('input[name="maxMonths"]');
            if (minMonths && pdf.minMonth != null) minMonths.value = pdf.minMonth;
            if (maxMonths && pdf.maxMonth != null) maxMonths.value = pdf.maxMonth;

            const fixedMonthsInput = document.querySelector('input[name="fixedMonths"]');
            if (fixedMonthsInput && joinType === "2") {
                const monthsFromText = termText.match(/\d+/g);
                if (monthsFromText && monthsFromText.length > 0) {
                    fixedMonthsInput.value = monthsFromText.join(",");
                } else if (termText) {
                    fixedMonthsInput.value = termText;
                }
                fixedMonthsInput.dispatchEvent(new Event("change", { bubbles: true }));
            }

            /* ì¶”ê°€ ë‚©ì… / ìë™ ì—°ì¥ / ë¶„í•  ì¸ì¶œ */
            const yesNo = (value) => {
                if (!value) return null;
                const cleaned = value.trim();
                if (cleaned.includes("ê°€ëŠ¥")) return "Y";
                if (cleaned.includes("ì—†ìŒ") || cleaned.includes("ë¶ˆê°€") || cleaned.includes("ë¶ˆê°€ëŠ¥")) return "N";
                return null;
            };

            setRadioValue("dpstAddPayYn", yesNo(pdf.additionalDeposit));
            setRadioValue("dpstAutoRenewYn", yesNo(pdf.autoRenewal));
            setRadioValue("dpstPartWdrwYn", yesNo(pdf.partialWithdrawal));

            renderAiComments(pdf);
        }


        /* ============================
           ğŸ“¤ PDF ì—…ë¡œë“œ
        ============================= */
        document.getElementById("btnPdfUpload").addEventListener("click", async () => {
            const fileInput = document.getElementById("dpstInfoPdfUpload");

            if (fileInput.files.length === 0) {
                alert("PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            const form = new FormData();
            form.append("file", fileInput.files[0]);

            const res = await fetch("/flobank/admin/pdf-ai/upload", {
                method: "POST",
                body: form
            });

            if (!res.ok) {
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
                return;
            }

            const result = await res.json();
            console.log("ğŸ“¦ ì—…ë¡œë“œ ì‘ë‹µ:", result);

            alert("ì—…ë¡œë“œ ì„±ê³µ!");
            loadPdfList();

            // ğŸ”¥ SSE ì—°ê²° ì‹œì‘
            connectProgressSSE(result.pdfId);
        });


        /* ============================
           âœ… PDF ì„ íƒ ì‹œ ìë™ ëŒ€ì…
        ============================= */
        async function handlePdfSelection(event) {
            const selectedId = event.target.value;

            if (!selectedId) {
                resetAiCommentBox();
                return;
            }

            try {
                const res = await fetch(`/flobank/admin/pdf-ai/${selectedId}`);

                if (!res.ok) {
                    const message = await res.text();
                    alert(message || "PDF ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    event.target.value = "";
                    resetAiCommentBox();
                    return;
                }

                const data = await res.json();
                applyPdfDataToForm(data);
            } catch (error) {
                console.error(error);
                alert("PDF ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        /* ============================
           ğŸ“„ PDF ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        ============================= */
        async function loadPdfList() {
            try {
                const res = await fetch("/flobank/admin/pdf-ai/list");
                if (!res.ok) {
                    throw new Error("PDF ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }

                const list = await res.json();

                const body = document.getElementById("pdfListBody");
                const selector = document.getElementById("pdfSelector");

                body.innerHTML = "";
                selector.innerHTML = `<option value="">ì„ íƒí•˜ì„¸ìš”</option>`;

                list.forEach(item => {
                    const createdAt = formatDateTime(item.createdAt);
                    const riskLabel = item.aiOverallRisk ? `<span class="ai-risk-chip ai-risk-${(item.aiOverallRisk || '').toLowerCase()}">${item.aiOverallRisk}</span>` : "";

                    body.innerHTML += `
                <div class="pdf-list-item" data-pdf-id="${item.pdfId}">
                    <div>
                        <strong>${item.orgFileName}</strong>
                        <div class="pdf-meta">${createdAt}</div>
                    </div>
                    <div class="pdf-status-cluster">
                        <span class="status-chip status-${item.status}">${item.status}</span>
                        ${riskLabel}
                        <button type="button" class="pdf-delete-btn" data-pdf-id="${item.pdfId}">Ã—</button>
                    </div>
                </div>
            `;

                    if (item.status === "done") {
                        selector.innerHTML += `
                    <option value="${item.pdfId}">
                        ${item.orgFileName} (done)
                    </option>
                `;
                    }
                });

                bindPdfDeleteButtons();
            } catch (error) {
                console.error(error);
                alert(error.message || "PDF ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function bindPdfDeleteButtons() {
            const container = document.getElementById("pdfListBody");
            if (!container) return;

            container.querySelectorAll(".pdf-delete-btn").forEach(btn => {
                btn.addEventListener("click", async (event) => {
                    event.stopPropagation();
                    const pdfId = btn.getAttribute("data-pdf-id");

                    if (!pdfId) return;

                    if (!confirm("PDFë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                    const res = await fetch(`/flobank/admin/pdf-ai/${pdfId}`, { method: "DELETE" });

                    if (!res.ok) {
                        const message = await res.text();
                        alert(message || "PDF ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        return;
                    }

                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadPdfList();
                });
            });
        }

        function initPdfAccordion() {
            const header = document.getElementById("pdfListHeader");
            const body = document.getElementById("pdfListBody");
            const arrow = document.getElementById("pdfListArrow");

            if (!header || !body || !arrow) return;

            header.addEventListener("click", () => {
                const isHidden = body.style.display === "none";
                body.style.display = isHidden ? "flex" : "none";
                arrow.textContent = isHidden ? "â–²" : "â–¼";
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            initPdfAccordion();
            loadPdfList();
            const selector = document.getElementById("pdfSelector");
            if (selector) {
                selector.addEventListener("change", handlePdfSelection);
            }
        });
    </script>

    <script th:src="@{/js/product1.js}"></script>
    <script th:src="@{/js/product2.js}"></script>

</th:block>

</html>
