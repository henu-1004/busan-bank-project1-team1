<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:insert="~{admin/admin_template :: admin_template('외화예금 관리','외화예금 관리',~{::body})}">
<body>

<!-- 외화예금 상품 전체 컨테이너 -->
<div class="product-container">

    <!-- 상품 등록 카드 -->
    <section class="product-card">
        <h2 class="product-title">외화예금 상품 등록</h2>

        <form id="foreignDepositForm"
              th:action="@{/admin/products/register}"
              method="post">

            <!-- ==========================
                 📌 PDF AI 분석 UI 영역
            =========================== -->
            <div class="form-section">
                <h3>상품설명서 AI 분석 준비</h3>

                <!-- PDF 업로드 -->
                <div class="form-group">
                    <label for="dpstInfoPdfUpload">PDF 파일 선택</label>

                    <div class="pdf-upload-controls">
                        <input type="file" id="dpstInfoPdfUpload" accept=".pdf" />
                        <button type="button" id="btnPdfUpload" class="btn-secondary">업로드</button>
                    </div>

                    <small class="helper-text">업로드 후 AI 분석 결과를 기다려 주세요.</small>
                </div>

                <!-- PDF 목록 -->
                <div class="pdf-list">
                    <div class="pdf-list-header">
                        <span>업로드된 PDF 목록</span>
                        <span class="status-legend">상태: wait / done / used</span>
                    </div>

                    <div class="pdf-list-body" id="pdfListBody">
                        <!-- JS로 목록이 채워집니다 -->
                    </div>
                </div>

                <!-- done 상태만 선택 가능한 드롭다운 -->
                <div class="form-group">
                    <label for="pdfSelector">AI 분석 완료 PDF 선택 (done만 선택 가능)</label>
                    <select id="pdfSelector" name="donePdf" class="pdf-select">
                        <option value="">선택하세요</option>
                        <!-- JS에서 done만 option 생성 예정 -->
                    </select>
                </div>

                <!-- AI 코멘트 박스 -->
                <div class="ai-comment-box">
                    <div class="ai-comment-header">
                        <h4>AI 분석 코멘트</h4>
                        <span class="ai-comment-status">AI 분석 코멘트 표시 예정</span>
                    </div>
                    <p class="ai-comment-placeholder">
                        AI 분석이 완료되면 생성된 코멘트가 이 영역에 표시됩니다.
                    </p>
                </div>
            </div>




            <!-- ==============================
                 📌 기본정보
            =============================== -->
            <div class="form-section">
                <h3>기본정보</h3>

                <div class="form-group">
                    <label for="dpstName">상품명</label>
                    <input type="text" id="dpstName" name="dpstName" placeholder="상품명을 입력하세요" required />
                </div>

                <div class="form-group">
                    <label for="dpstInfo">상품 한 줄 설명</label>
                    <input type="text" id="dpstInfo" name="dpstInfo" placeholder="간단한 설명을 입력하세요" />
                </div>

                <div class="form-group">
                    <label>예금 유형</label>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstType" value="1" checked /> 거치식 예금</label>
                        <label><input type="radio" name="dpstType" value="2" /> 자유 적립식</label>
                    </div>
                </div>
            </div>


            <!-- ==============================
                 📌 통화 및 금액 설정
            =============================== -->
            <div class="form-section">
                <h3>통화 및 금액 설정</h3>

                <div class="form-group">
                    <label>가능한 통화</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="dpstCurrency" value="USD" /> USD(미국 달러)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="JPY" /> JPY(일본 엔화)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="EUR" /> EUR(유로화)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="GBP" /> GBP(영국 파운드)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="CNY" /> CNY(중국 위안)</label>
                        <label><input type="checkbox" name="dpstCurrency" value="AUD" /> AUD(호주 달러)</label>
                    </div>
                </div>

                <div class="conditional deposit-type" data-type="1">
                    <div id="currencyAmountContainer"></div>

                    <div class="form-group">
                        <label>추가납입 가능 여부</label>
                        <div class="radio-group">
                            <label><input type="radio" name="dpstAddPayYn" value="Y" /> 가능</label>
                            <label><input type="radio" name="dpstAddPayYn" value="N" checked /> 불가능</label>
                        </div>
                    </div>

                    <div class="conditional extra-deposit">
                        <div class="form-group">
                            <label>신규 포함 최대 납입 횟수</label>
                            <input type="number" name="dpstAddPayMax" placeholder="예: 3" />
                        </div>
                    </div>
                </div>
            </div>


            <!-- ==============================
                 📌 환율 적용 기준
            =============================== -->
            <div class="form-section">
                <h3>환율 적용 기준</h3>
                <div class="radio-group">
                    <label><input type="radio" name="dpstRateType" value="1" checked /> 가입 시점</label>
                    <label><input type="radio" name="dpstRateType" value="2" /> 만기 시점</label>
                </div>
            </div>


            <!-- ==============================
                 📌 상품 정보
            =============================== -->
            <div class="form-section">
                <h3>상품 정보</h3>

                <div class="form-group">
                    <label for="dpstDescript">상품 개요</label>
                    <textarea id="dpstDescript" name="dpstDescript" rows="3" placeholder="상품 특징 및 안내를 입력하세요"></textarea>
                </div>

                <div class="form-group">
                    <label>상품 가입기간 유형</label>
                    <div class="radio-group">
                        <label><input type="radio" name="dpstPeriodType" value="1" checked /> 자유형</label>
                        <label><input type="radio" name="dpstPeriodType" value="2" /> 고정형</label>
                    </div>
                </div>

                <div class="conditional join-type" data-type="1">
                    <div class="form-inline">
                        <label>최소 가입월수</label>
                        <input type="number" name="minMonths" placeholder="예: 1" /> 개월
                    </div>
                    <div class="form-inline">
                        <label>최대 가입월수</label>
                        <input type="number" name="maxMonths" placeholder="예: 36" /> 개월
                    </div>
                </div>

                <div class="conditional join-type" data-type="2">
                    <div class="form-group">
                        <label>가입 가능한 개월수</label>
                        <input type="text" name="fixedMonths" placeholder="예: 3,6,12" />
                    </div>
                </div>
            </div>


            <!-- ==============================
                 📌 가입 대상
            =============================== -->
            <div class="form-section">
                <h3>가입 대상</h3>

                <div class="radio-group">
                    <label><input type="radio" name="ageLimit" value="none" checked /> 제한 없음</label>
                    <label><input type="radio" name="ageLimit" value="yes" /> 제한 있음</label>
                </div>

                <div class="conditional age-limit">
                    <div class="form-inline">
                        <label>최소 나이</label>
                        <input type="number" name="dpstMinAge" placeholder="예: 19" /> 세
                    </div>
                    <div class="form-inline">
                        <label>최대 나이</label>
                        <input type="number" name="dpstMaxAge" placeholder="예: 65" /> 세
                    </div>
                </div>
            </div>


            <!-- ==============================
                 📌 분할 인출
            =============================== -->
            <div class="form-section">
                <h3>분할 인출 설정</h3>

                <div class="radio-group">
                    <label><input type="radio" name="dpstPartWdrwYn" value="Y" /> 가능</label>
                    <label><input type="radio" name="dpstPartWdrwYn" value="N" checked /> 불가능</label>
                </div>

                <div class="conditional partial-withdrawal">
                    <div class="form-group">
                        <label>가능 시점 (가입 후)</label>
                        <input type="number" name="withdrawAfterMonths" placeholder="예: 6" /> 개월 이후
                    </div>

                    <div class="form-group">
                        <label>최대 인출 가능 횟수</label>
                        <input type="number" name="withdrawCount" placeholder="예: 3회" />
                    </div>

                    <div id="withdrawCurrencyContainer"></div>
                </div>
            </div>


            <!-- ==============================
                 📌 자동연장
            =============================== -->
            <div class="form-section">
                <h3>자동연장 설정</h3>

                <div class="radio-group">
                    <label><input type="radio" name="dpstAutoRenewYn" value="Y" /> 가능</label>
                    <label><input type="radio" name="dpstAutoRenewYn" value="N" checked /> 불가능</label>
                </div>

                <div class="conditional auto-renew">
                    <div class="form-group">
                        <label>연장 기간 선택</label>
                        <select name="renewPeriod">
                            <option value="">선택하세요</option>
                            <option value="1">1개월</option>
                            <option value="3">3개월</option>
                            <option value="6">6개월</option>
                            <option value="12">12개월</option>
                        </select>
                    </div>
                </div>
            </div>


            <!-- ==============================
                 📌 상품 설명서 첨부 (최종본)
            =============================== -->
            <div class="form-section">
                <h3>상품설명서 첨부</h3>
                <div class="form-group">
                    <input type="file" name="dpstInfoPdf" accept=".pdf,.doc,.docx" />
                </div>
            </div>


            <!-- ==============================
                 📌 상품 개시일
            =============================== -->
            <div class="form-section">
                <h3>상품 개시일자</h3>

                <div class="form-group">
                    <label for="dpstRegDt">개시일자 선택</label>
                    <input type="date" id="dpstRegDt" name="dpstRegDt" required />
                </div>
            </div>


            <div class="form-submit">
                <button type="submit" class="btn-submit">등록하기</button>
            </div>

        </form>
    </section>


    <!-- ==============================
         📌 상품 관리(아래는 그대로 유지)
    =============================== -->
    <section class="product-card">

        <h2 class="product-title">외화예금 상품 관리</h2>

        <div class="product-tabs">
            <button class="tab-btn active" data-status="approve">승인 대기 중</button>
            <button class="tab-btn" data-status="pending">상품 등록 대기 중</button>
        </div>

        <div class="product-table-wrap" data-status-group="approve">
            <table class="product-table">
                <thead>
                <tr>
                    <th>상품명</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${approveList}" data-status="approve" th:data-id="${p.dpstId}">
                    <td th:text="${p.dpstName}"></td>
                    <td><span class="status-badge status-approve">승인 대기 중</span></td>
                    <td><button class="btn-approve">승인</button></td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="product-table-wrap" data-status-group="pending" style="display:none;">
            <table class="product-table">
                <thead>
                <tr>
                    <th>상품명</th>
                    <th>상태</th>
                    <th>상품 개시일</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${pendingList}" th:data-id="${p.dpstId}">
                    <td th:text="${p.dpstName}"></td>
                    <td><span class="status-badge status-pending">상품 등록 대기 중</span></td>
                    <td th:text="${p.dpstRegDt}"></td>
                </tr>
                </tbody>
            </table>
        </div>

    </section>


    <section class="product-card">
        <h2 class="product-title">외화예금 상품 현황</h2>

        <div class="product-table-wrap">
            <table class="product-table">
                <thead>
                <tr>
                    <th>상품명</th>
                    <th>상품판매개시일시</th>
                    <th>가입자수</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody>

                <tr th:each="p : ${saleList}">
                    <td>
                        <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                           class="product-link"
                           th:text="${p.dpstName}"></a>
                    </td>
                    <td th:text="${p.dpstRegDt}"></td>
                    <td>0</td>
                    <td><span class="status-badge status-sale">판매중</span></td>
                </tr>

                <tr th:each="p : ${stopList}">
                    <td>
                        <a th:href="@{/admin/products/view/{id}(id=${p.dpstId})}"
                           class="product-link"
                           th:text="${p.dpstName}"></a>
                    </td>
                    <td th:text="${p.dpstRegDt}"></td>
                    <td>0</td>
                    <td><span class="status-badge status-stop">판매중단</span></td>
                </tr>

                </tbody>
            </table>
        </div>
    </section>

</div>

<!-- ==========================
     📌 PDF 업로드 & 목록 조회 JS
=========================== -->
<script>
    // ==========================
    // PDF 업로드
    // ==========================
    document.getElementById("btnPdfUpload").addEventListener("click", async () => {

        const input = document.getElementById("dpstInfoPdfUpload");

        if (input.files.length === 0) {
            alert("PDF 파일을 선택하세요.");
            return;
        }

        const form = new FormData();
        form.append("file", input.files[0]);

        const res = await fetch("/flobank/admin/pdf-ai/upload", {
            method: "POST",
            body: form
        });

        if (!res.ok) {
            alert("업로드 실패");
            return;
        }

        alert("업로드 성공!");
        loadPdfList();
    });


    // ==========================
    // PDF 목록 조회
    // ==========================
    async function loadPdfList() {
        const res = await fetch("/flobank/admin/pdf-ai/list");
        const list = await res.json();

        const body = document.getElementById("pdfListBody");
        const selector = document.getElementById("pdfSelector");

        body.innerHTML = "";
        selector.innerHTML = `<option value="">선택하세요</option>`;

        list.forEach(item => {

            // 목록 출력
            body.innerHTML += `
                <div class="pdf-list-item">
                    <div>
                        <strong>${item.orgFileName}</strong>
                        <div class="pdf-meta">${item.createdAt || ''}</div>
                    </div>
                    <span class="status-chip status-${item.status}">${item.status}</span>
                </div>
            `;

            // done만 드롭다운에 넣기
            if (item.status === "done") {
                selector.innerHTML += `
                    <option value="${item.pdfId}">
                        ${item.orgFileName} (done)
                    </option>
                `;
            }
        });
    }

    // 페이지 로딩 시 초기 목록
    document.addEventListener("DOMContentLoaded", loadPdfList);
</script>


<script th:src="@{/js/product1.js}"></script>
<script th:src="@{/js/product2.js}"></script>

</body>
</html>
