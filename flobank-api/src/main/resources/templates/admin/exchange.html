<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/admin_template :: admin_template('환전 관리','환전 관리',~{::content},~{::script})}">

<th:block th:fragment="content">

<!-- 환전 통계 영역 -->
        <section class="admin-exchange-stats-row">
            <article class="admin-exchange-card admin-exchange-graph-card">
                <h3>일자별 통화 환전금액
                       <span th:text="| ${#temporals.format(baseTime, 'yyyy.MM.dd HH:mm:ss')} 기준)|"></span>
                </h3>

                <!--  날짜 선택 UI 추가 -->
                <div class="admin-exchange-date-picker" style="margin-bottom:10px;">
                    <input type="date" id="exchangeDatePicker"
                           th:value="${baseTime != null ? #temporals.format(baseTime,'yyyy-MM-dd') : ''}" />
                </div>

                <!-- 통화 필터 -->
                <div class="admin-exchange-filter" id="currencyFilter"></div>

                <!--  통화별 환전 그래프 -->
                <div class="admin-exchange-graph-box">
                    <canvas id="currencyDailyChart"></canvas>
                </div>




            </article>

            <article class="admin-exchange-card admin-exchange-graph-card">
                <h3>일자별 환전액
                    <span th:text="| ${#temporals.format(baseTime, 'yyyy.MM.dd HH:mm:ss')} 기준)|"></span>
                </h3>
                <div class="admin-exchange-graph-box admin-exchange-graph-box--compact">
                    <canvas id="dailyTotalChart"></canvas>
                </div>
            </article>
        </section>

        <!-- 환전 이력 섹션 -->
    <section class="admin-exchange-section" id="exchangeHistorySection">
        <h2 class="admin-exchange-section-title">환전 이력</h2>


            <!-- 검색 -->
            <form class="admin-exchange-search" th:action="@{/admin/exchange}" method="get">
                <select id="exchangeSearchType" name="searchType" th:value="${searchType}">
                    <option value="customer" th:selected="${searchType} == 'customer'">고객번호</option>
                    <option value="exchange" th:selected="${searchType} == 'exchange'">환전번호</option>

                </select>

                <input type="text" id="exchangeSearchInput" name="keyword" placeholder="검색어를 입력하세요" th:value="${keyword != null && keyword != 'null' ? keyword : ''}" />                <input type="hidden" name="couponPage" th:value="${couponPage}" />
                <button id="exchangeSearchBtn" type="submit">검색</button>
            </form>




            <!-- 테이블 -->
            <div class="admin-exchange-table-container">
                <table class="admin-exchange-table">
                    <thead>
                    <tr>
                        <th>고객번호</th>
                        <th>환전번호</th>
                        <th>환전 전 통화</th>
                        <th>환전 후 통화</th>
                        <th>적용환율</th>
                        <th>환전 신청일시</th>
                    </tr>
                    </thead>
                    <tbody id="exchangeTableBody">
                    <tr th:if="${#lists.isEmpty(exchangeList)}">
                        <td colspan="6" class="empty-data">표시할 환전 이력이 없습니다.</td>

                    </tr>
                    <tr th:each="row : ${exchangeList}">
                        <td th:text="${row.custCode}">10001</td>
                        <td th:text="${row.exchNo}">EX20251111001</td>
                        <td th:text="${row.exchFromCurrency}">KRW</td>
                        <td th:text="${row.exchToCurrency}">USD</td>
                        <td th:text="${row.exchAppliedRate != null ? #numbers.formatDecimal(row.exchAppliedRate, 0, 4) : '-'}">1,470.59</td>
                        <td th:text="${row.lastUpdatedAt != null ? #temporals.format(row.lastUpdatedAt, 'yyyy-MM-dd HH:mm:ss') : '-'}">2025-11-11 09:13:22</td>

                    </tr>

                    </tbody>
                </table>
            </div>



        <!-- 페이지네이션 -->
        <div class="pagination">

            <!-- Prev -->
            <a class="page-btn"
               th:classappend="${exchangePage <= 1} ? ' disabled'"
               th:href="@{|/admin/exchange?page=${exchangePage - 1 < 1 ? 1 : exchangePage - 1}&couponPage=${couponPage}&searchType=${searchType}&keyword=${keyword}#exchangeHistorySection|}">
                «
            </a>

            <!-- Page numbers -->
            <a class="page-btn"
               th:each="p : ${#numbers.sequence(1, exchangeTotalPage)}"
               th:classappend="${p} == ${exchangePage} ? ' active'"
               th:href="@{|/admin/exchange?page=${p}&couponPage=${couponPage}&searchType=${searchType}&keyword=${keyword}#exchangeHistorySection|}"
               th:text="${p}">
            </a>

            <!-- Next -->
            <a class="page-btn"
               th:classappend="${exchangePage >= exchangeTotalPage} ? ' disabled'"
               th:href="@{|/admin/exchange?page=${exchangePage + 1 > exchangeTotalPage ? exchangeTotalPage : exchangePage + 1}&couponPage=${couponPage}&searchType=${searchType}&keyword=${keyword}#exchangeHistorySection|}">
                »
            </a>

        </div>



    </section>

        <!-- 환전 수수료 쿠폰 발급 현황 -->
    <section class="admin-exchange-section" id="couponSection">
        <h2 class="admin-exchange-section-title">환전 수수료 쿠폰 발급 현황</h2>

            <div class="admin-exchange-table-container">
                <table class="admin-exchange-table">
                    <thead>
                    <tr>
                        <th>고객번호</th>
                        <th>쿠폰번호</th>
                        <th>발급일자</th>
                        <th>쿠폰명</th>
                        <th>상태</th>
                    </tr>
                    </thead>
                    <tbody>

                    <tr th:if="${#lists.isEmpty(couponList)}">
                        <td colspan="5" class="empty-data">표시할 쿠폰 발급 내역이 없습니다.</td>

                    </tr>

                    <tr th:each="coupon : ${couponList}">
                        <td th:text="${coupon.custCode}">10001</td>
                        <td th:text="${coupon.couponNo}">CPN2025110101</td>
                        <td th:text="${coupon.issuedDate}">2025-11-01</td>
                        <td th:text="|수수료 ${coupon.coupRate}% 할인 쿠폰|">수수료 5% 할인 쿠폰</td>
                        <td th:classappend="${coupon.coupStatus} == 1 ? ' admin-exchange-status-unused' : ' admin-exchange-status-used'"
                            th:text="${coupon.coupStatus} == 1 ? '미사용' : '사용'">미사용</td>


                    </tr>
                    </tbody>
                </table>
            </div>


        <div class="pagination">

            <!-- Prev -->
            <a class="page-btn"
               th:classappend="${couponPage <= 1} ? ' disabled'"
               th:href="@{|/admin/exchange?page=${exchangePage}&couponPage=${couponPage - 1 < 1 ? 1 : couponPage - 1}&searchType=${searchType}&keyword=${keyword}#couponSection|}">
                «
            </a>

            <!-- Page numbers -->
            <a class="page-btn"
               th:each="p : ${#numbers.sequence(1, couponTotalPage)}"
               th:classappend="${p} == ${couponPage} ? ' active'"
               th:href="@{|/admin/exchange?page=${exchangePage}&couponPage=${p}&searchType=${searchType}&keyword=${keyword}#couponSection|}"
               th:text="${p}">
            </a>

            <!-- Next -->
            <a class="page-btn"
               th:classappend="${couponPage >= couponTotalPage} ? ' disabled'"
               th:href="@{|/admin/exchange?page=${exchangePage}&couponPage=${couponPage + 1 > couponTotalPage ? couponTotalPage : couponPage + 1}&searchType=${searchType}&keyword=${keyword}#couponSection|}">
                »
            </a>

        </div>



        </section>
    </th:block>

<th:block th:fragment="script">


    <script th:inline="javascript">
        /*<![CDATA[*/
        window.exchangeStats = {
            currencyDailyAmounts: [
                /*[# th:if="${stats != null && stats.currencyDailyAmounts != null}"]*/
                /*[# th:each="row, iter : ${stats.currencyDailyAmounts}"]*/
                {
                    baseDate: /*[[${row.baseDate}]]*/ '',
                    currency: '[[${row.currency}]]',
                    amountKrw: [[${row.amountKrw}]]
                }/*[# th:if="${!iter.last}"]*/,/*[/]*/
                /*[/]*/
                /*[/]*/
            ],

            dailyTotals: [
                /*[# th:if="${stats != null && stats.dailyTotals != null}"]*/
                /*[# th:each="row, iter : ${stats.dailyTotals}"]*/
                {
                    baseDate: /*[[${row.baseDate}]]*/ '',
                    amountKrw: [[${row.amountKrw}]]
                }/*[# th:if="${!iter.last}"]*/,/*[/]*/
                /*[/]*/
                /*[/]*/
            ],

            lastUpdatedAt: '[[${stats != null ? stats.lastUpdatedAt : ''}]]'
        };
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/admin_exchange.js}"></script>

</th:block>


</html>
